<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8">
        <title>Racket FFI 3</title>
        <meta name="description" content="这是关于Racket的FFI的使用的第三篇讲解.在这篇博文中我们会涉及到一些底层的操作.包括指针,联合体和自定义的C数据类型.主要还是自定义类型,它可以让你在使用racket和c互交的时候进行抽象进而不需要了解具体的c语言的表现形式....">
        <meta name="author"      content="Mr.λ">
        <meta name="keywords"    content="Racket, FFI">
        <meta name="viewport"    content="width=device-width, initial-scale=1.0">
        <link rel="icon"      href="/favicon.ico">
        <link rel="canonical" href="http://shenxs.github.io/blog/2016/07/22/racket-ffi-3/">
        <link rel="next" href="/blog/2016/07/21/racket-ffi-2/">
        <link rel="prev" href="/blog/2016/10/06/raspberry-pi-gpio/">
        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="/css/pygments.css">
        <link rel="stylesheet" type="text/css" href="/css/scribble.css">
        <link rel="stylesheet" type="text/css" href="/css/custom.css">
        <!-- Feeds -->
        <link rel="alternate" type="application/atom+xml"
                              href="/feeds/all.atom.xml" title="Atom Feed">
        <link rel="alternate" type="application/rss+xml"
                              href="/feeds/all.rss.xml" title="RSS Feed">
        <!-- JS -->
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-xxxxx', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- Theme CSS -->
        <link href="css/clean-blog.min.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    </head>
    <body>
        <!-- A standard Twitter Bootstrap nav bar -->
        <header class="navbar navbar-default navbar-inverse"
                role="banner">
            <div class="container">
                <div class="navbar-header">
                    <button type="button"
                            class="navbar-toggle"
                            data-toggle="collapse"
                            data-target=".our-nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a href="/index.html" class="navbar-brand">主页</a>
                </div>
                <div class="collapse navbar-collapse our-nav-collapse"
                     role="navigation">
                    <ul class="nav navbar-nav">

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                Tags <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="/index.html">所有文章</a></li>

<li><a href="/tags/bar.html">bar</a></li>

<li><a href="/tags/baz.html">baz</a></li>

<li><a href="/tags/FFI.html">FFI</a></li>

<li><a href="/tags/foo.html">foo</a></li>

<li><a href="/tags/frog.html">frog</a></li>

<li><a href="/tags/github-test.html">github test</a></li>

<li><a href="/tags/Racket.html">Racket</a></li>

<li><a href="/tags/racket.html">racket</a></li>

<li><a href="/tags/Raspberry-树莓派的GPIO.html">Raspberry

树莓派的GPIO</a></li>

<li><a href="/tags/scheme.html">scheme</a></li>

<li><a href="/tags/sicp.html">sicp</a></li>

<li><a href="/tags/ssd.html">ssd</a></li>

<li><a href="/tags/tag-with-spaces.html">tag with spaces</a></li>

<li><a href="/tags/ubuntu.html">ubuntu</a></li>

<li><a href="/tags/vim.html">vim</a></li>

<li><a href="/tags/windows10.html">windows10</a></li>

<li><a href="/tags/体会.html">体会;</a></li>

<li><a href="/tags/双系统.html">双系统</a></li>

<li><a href="/tags/平面国.html">平面国</a></li>

<li><a href="/tags/摘自-BCM2835-ARM-Peripherals.html">摘自《BCM2835 ARM Peripherals》</a></li>

<li><a href="/tags/斜体.html">斜体</a></li>

<li><a href="/tags/注释.html">注释</a></li>

<li><a href="/tags/混合硬盘.html">混合硬盘</a></li>

<li><a href="/tags/读记.html">读记</a></li>

<li><a href="/tags/重装.html">重装</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="/About.html">关于我</a>
                        </li> 
                        <li><a href="/feeds/all.atom.xml">Atom</a></li>
                        <li><a href="/feeds/all.rss.xml">RSS</a></li>
                    </ul>
                </div>
            </div>
        </header>
        <div class="container">
            <div class="row">

                <!-- Main column -->
                <div id="content" class="col-md-12">





                    <article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Racket FFI 3</h1>
                    <p class='date-and-tags'>
<time datetime="2016-07-22" pubdate="true">2016-07-22</time> :: <span class="tags"><a href="/tags/Racket.html">Racket</a>, <a href="/tags/FFI.html">FFI</a></span></p>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

<p>这是关于Racket的FFI的使用的第三篇讲解.在这篇博文中我们会涉及到一些底层的操作.包括指针,联合体和自定义的C数据类型.主要还是自定义类型,它可以让你在使用racket和c互交的时候进行抽象进而不需要了解具体的c语言的表现形式.</p>
<!-- more-->

<h2 id="准备工作">准备工作</h2>

<p>正如我们在第二篇博文中所做的那样,我们会从一些已有的代码出发,在此基础上完成我们的既定目标.但是首先,每次都需要写<code>#:c-id identifier</code>这样的标记来标志c的函数名是一件繁琐的事情.</p>

<p>可以通过安装第三方的包,让我们从琐碎中解放出来.在命令行下运行如下命令就可以了</p>

<div class="brush: shell">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span>$ raco pkg install ffi-definer-convention
</pre></div>
</td></tr></tbody></table>
</div>

<p>然后是我们的代码部分,我们已经有这些代码了</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">racket/draw</span>
         <span class="n">ffi/unsafe</span>
         <span class="c1">; avoid conflict with below</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._except-in))" style="color: inherit">except-in</a></span> <span class="n">ffi/unsafe/define</span>
                    <span class="n">define-ffi-definer</span><span class="p">)</span>
         <span class="c1">; the new 3rd-party pkg</span>
         <span class="n">ffi-definer-convention</span>
         <span class="n">pict</span><span class="p">)</span>

<span class="c1">; C types</span>
<span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_tagged-pointers.html#(form._((lib._ffi/unsafe..rkt)._define-cpointer-type))" style="color: inherit">define-cpointer-type</a></span> <span class="n">_cairo_t</span><span class="p">)</span>
<span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_tagged-pointers.html#(form._((lib._ffi/unsafe..rkt)._define-cpointer-type))" style="color: inherit">define-cpointer-type</a></span> <span class="n">_cairo_surface_t</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_line_cap_t</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Enumerations_and_Masks.html#(def._((lib._ffi/unsafe..rkt).__enum))" style="color: inherit">_enum</a></span> <span class="o">'</span><span class="p">(</span><span class="ss">butt</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._round))" style="color: inherit">round</a></span> <span class="ss">square</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cairo-lib</span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._ffi-lib))" style="color: inherit">ffi-lib</a></span> <span class="no">#f</span><span class="p">))</span>
<span class="p">(</span><span class="n">define-ffi-definer</span> <span class="n">define-cairo</span> <span class="n">cairo-lib</span>
  <span class="c1">; describes how to transform from</span>
  <span class="c1">; Racket to C ids</span>
  <span class="kd">#:make-c-id</span> <span class="n">convention:hyphen-&gt;underscore</span><span class="p">)</span>

<span class="c1">; the foreign functions</span>
<span class="c1">; note lack of #:c-id keyword arguments</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-create</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_surface_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">_cairo_t</span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-move-to</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-line-to</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-set-line-width</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-stroke</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-set-line-cap</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n">_cairo_line_cap_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>

<span class="c1">; (_cairo_t -&gt; Void) -&gt; Pict</span>
<span class="c1">; do some drawing and give us the pict</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">do-cairo</span> <span class="n">f</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bt</span> <span class="p">(</span><span class="n">make-bitmap</span> <span class="mi">256</span> <span class="mi">256</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bt-surface</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bt</span> <span class="n">get-handle</span><span class="p">))</span>
  <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">cairo-create</span> <span class="n">bt-surface</span><span class="p">))</span>
  <span class="p">(</span><span class="n">linewidth</span> <span class="mi">2</span> <span class="p">(</span><span class="n">frame</span> <span class="p">(</span><span class="n">bitmap</span> <span class="n">bt</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>注意,这里<code>define-cairo</code>函数不再需要<code>#:c-id identifier</code>这样的标志了.这里的<code>define-ffi-definer</code>是来自第三方的包<code>ffi-definer-convention</code>中.在一开始定义define-cairo的时候边设定好函数名的转换规则,这里的转换规则是从连字符到下划线,<code>-</code> 到 <code>_</code>.</p>

<p>而且,此处定义了一个函数<code>do-cairo</code>,这样我们也不用再去自己定义一个<code>bitmap</code>了.<code>do-cairo</code>将会接受一个绘制函数,在<code>bt</code>中绘制出来并显示.</p>

<h2 id="正章">正章</h2>

<p>准备得差不多是时候上硬菜了(我不是东北人).这次我们试试看使用Cairo库中的<code>path</code>对象.首先看看它是怎么定义的</p>

<div class="brush: c">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">cairo_status_t</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">cairo_path_data_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cairo_path_t</span><span class="p">;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>为了能使用path,我们需要定义一个Racket的FFI的C数据类型与之对应.在这之前需要先对path的成员变量类型定义</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_status_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这实际上是个枚举类型,在这篇博文中我们并不在乎怎么区分不同的状态.第二个成员变量类型实际是一个数组类型,数组中放的是path的data对象.而<code>cairo_path_data_t</code>是一个联合体,其定义如下</p>

<div class="brush: c">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">union</span> <span class="n">_cairo_path_data_t</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">cairo_path_data_type_t</span> <span class="n">type</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">header</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">point</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>FFI当然可以方便的支持结构体了.使用<code>_union</code>构造函数即可.<code>_union</code>构造函数可以接受任意数量的参数,每一个都是这个联合体的一种子情况.所以在Racket中定义一个联合体easy.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">;这就是一个枚举类型</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_data_type_t</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Enumerations_and_Masks.html#(def._((lib._ffi/unsafe..rkt).__enum))" style="color: inherit">_enum</a></span> <span class="o">'</span><span class="p">(</span><span class="ss">move-to</span> <span class="ss">line-to</span> <span class="ss">curve-to</span> <span class="ss">close-path</span><span class="p">)))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_data_t</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt).__union))" style="color: inherit">_union</a></span> <span class="c1">; the header case</span>
            <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n">_cairo_path_data_type_t</span>
                          <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">)</span>
            <span class="c1">; the point case</span>
            <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这里有一个从未见过的构造函数<code>_list-struct</code>.此构造函数可以在c和racket之间传递一个结构体,此结构体成员变量的数据类型紧随其后.文档上说这不是一个高效的函数.如果对于效率有要求的话可以使用<code>define-cstruct</code>.并且这个构造函数并不会像<code>define-cstruct</code>那样附带定义选择函数,谓词函数等.不过你可以像一个普通的列表那样操作这个数据类型.</p>

<p>联合体使用起来比较繁复,因为在Racket这边你必须要手动区分不同的情况.我们用一些代码来演示这个问题:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">; 用一个double型的list构建一个联合体</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">a-union-val</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#(form._((lib._typed-racket/base-env/prims..rkt)._cast))" style="color: inherit">cast</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="mf">1.3</span> <span class="mf">5.8</span><span class="p">)</span>
          <span class="c1">; source type</span>
          <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span><span class="p">)</span>
          <span class="c1">; target type</span>
          <span class="n">_cairo_path_data_t</span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">a-union-val</span>
<span class="n">#&lt;union&gt;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这个小例子中用到<code>cast</code>来构建一个<code>_cairo_path_data_t</code>.<code>cast</code>可以将一个c数据类型强制转换为另一个.因为使用<code>cast</code>构建一个联合体比较方便所以在这个例子中用到了它.</p>

<p>从第二行的输出可以看出,我们并不知道一个联合体里面放的到底是什么.当然你可以使用<code>union-ref</code>函数取出联合体里面的东西但是这是不安全的,因为你无法确定里面的数据类型,所以取出的数据可能是无效的数据.</p>

<p>据个例子来说明一下</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">; 正确的打开方式</span>
<span class="c1">; 各种情况的顺序由定义时确定,序号从0开始</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="n">a-union-val</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mf">1.3</span> <span class="mf">5.8</span><span class="p">)</span>
<span class="c1">; 错误的打开方式</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="n">a-union-val</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">enum:int-&gt;_cairo_path_data_type_t:</span> <span class="n">expected</span> <span class="n">a</span> <span class="n">known</span>
<span class="n">#&lt;ctype:ufixint&gt;</span><span class="o">,</span> <span class="n">got:</span> <span class="mi">3435973837</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这里错误的打开方式racket给我们报错了.这次比较幸运因为在通常情况下你只会得到一个毫无意义的数据,并不会报错.这时候人生就比较悲剧了.查错是十分困难的.</p>

<p>像这样的联合体通常都会有办法确定联合体里面到底放的是那种数据类型的数据.有可能在c那边会额外增加一个结构体或者值来说明这个值的数据类型.或者是某些设定说明了结构体里面放的是什么.原文<code>Alternatively, there may be some set order that cases appear in data structures.</code></p>

<p>对于<code>Cairo</code>的api而言数组中的头元素就可以用来确定联合体中存放的值的数据类型.</p>

<p>在继续之前先总结一下,我们已经有一个用来描述path data的联合体,接下来看看怎么处理数组.</p>

<h2 id="一些底层操作">一些底层操作</h2>

<p>由于我们还没有与c对应的<code>cairo_path_t</code>,马上来定义一个好了.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_simple_cairo_path_t</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n">_cairo_status_t</span>
                  <span class="n"><a href="http://docs.racket-lang.org/foreign/Pointer_Types.html#(def._((quote._~23~25foreign).__pointer))" style="color: inherit">_pointer</a></span>
                  <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">))</span> 
</pre></div>
</td></tr></tbody></table>
</div>

<p>在这里我们只是使用指针<code>_pointer</code> 来表示数组.为了安全性可以考虑使用 &rsquo;_cpointer <code>cairo_status_t&gt;</code>,这样就申明了一个标记了的c指针了,(好像对c的指针打上标记以将其和其他的c指针区分开来那样).</p>

<p>我们之前也见过这种指针类型的数据类型,但是除了将它作为参数传递以外什么也没做.实际上指针类型也是可以被操作的,除了作为参数简单的传递之外.</p>

<p>在我们这么做之前先将<code>cairo_copy_path</code>进行绑定,这样我们才能去操作一个路径的结构体</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-copy-path</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Pointer_Types.html#(def._((quote._~23~25foreign).__pointer))" style="color: inherit">_pointer</a></span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>来试试看</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">a-path</span> <span class="no">#f</span><span class="p">)</span>

<span class="p">(</span><span class="n">do-cairo</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
              <span class="c1">; Do stuff to make the current</span>
              <span class="c1">; path non-empty</span>
              <span class="p">(</span><span class="n">cairo-move-to</span> <span class="n">ctx</span> <span class="mf">50.0</span> <span class="mf">50.0</span><span class="p">)</span>
              <span class="p">(</span><span class="n">cairo-line-to</span> <span class="n">ctx</span> <span class="mf">206.0</span> <span class="mf">206.0</span><span class="p">)</span>
              <span class="p">(</span><span class="n">cairo-move-to</span> <span class="n">ctx</span> <span class="mf">50.0</span> <span class="mf">206.0</span><span class="p">)</span>
              <span class="p">(</span><span class="n">cairo-line-to</span> <span class="n">ctx</span> <span class="mf">115.0</span> <span class="mf">115.0</span><span class="p">)</span>
              <span class="c1">; Get the current path</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">a-path</span> <span class="p">(</span><span class="n">cairo-copy-path</span> <span class="n">ctx</span><span class="p">))</span>
              <span class="c1">; Stroke clears the path</span>
              <span class="c1">; so do it last</span>
              <span class="p">(</span><span class="n">cairo-stroke</span> <span class="n">ctx</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>let&rsquo;s run it</p>

<div class="figure"><img src="/img/ff31.png" alt="" />
 <p class="caption"></p></div>

<p>画出来一个λ ,这次再看看<code>a-path</code>被设置成什么了.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">a-path</span>
<span class="n">#&lt;cpointer&gt;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>记住,<code>cairo-copy-path</code>仅仅给我们一个指向path结构体的指针并不是直接一个结构体.因此我们需要知道如何使用一个指针类型的数据.对于指针最有用的函数是<code>ptr-ref</code>.可以让你取消引用一个指针进而得到具体的c类型.</p>

<p><strong>注意:</strong><code>ptr-ref</code>也可以接受一个可选的偏移量参数,这会在稍后的例子中提到.</p>

<p>例如,我们可以将<code>a-path</code>当做是<code>_sample_cairo_path_t</code>来使用:</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">simple-path</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">a-path</span> <span class="n">_simple_cairo_path_t</span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">simple-path</span>
<span class="o">'</span><span class="p">(</span><span class="mi">0</span> <span class="ss">#&lt;cpointer&gt;</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>现在我们已经有了这个指针所指向的结构体的Racket表示了.but 这里的data成员也是一个指针(代表的是数组).为了将他转化为一个更加有用的数据,我们将对数组再次使用<code>ptr-ref</code>.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">array</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="c1">; the pointer</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">simple-path</span><span class="p">)</span>
       <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt).__array/list))" style="color: inherit">_array/list</a></span> <span class="n">_cairo_path_data_t</span>
                    <span class="c1">; length field</span>
                    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._third))" style="color: inherit">third</a></span> <span class="n">simple-path</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>看看array中的内容</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="n">array</span>
<span class="o">'</span><span class="p">(</span><span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span> <span class="ss">#&lt;union&gt;</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>正如我们所期待的那样,这个array中都是联合体类型.联合体还是有点讨厌的,我们必须要知道其中存放的到底是哪一种数据类型,才能正确地取出数据.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span> <span class="n">array</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="ss">move-to</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">array</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mf">50.0</span> <span class="mf">50.0</span><span class="p">)</span>
<span class="c1">; 使用了错误的数据类型,从联合体中取出了无效的数据</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._third))" style="color: inherit">third</a></span> <span class="n">array</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">'</span><span class="p">(</span><span class="mf">4.2439915824246e-314</span> <span class="mf">3.7548080003146e-317</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>我们可以写一个辅助函数.将数组类型转化为更加有用的形式,这里可以从下标推断出正确的参数总是010101,间隔的(比如,first对应0 ,second对应1,third应该对应0,fourth应该对应1&hellip;..) <strong>注意</strong>这并非原文的解释,是我个人的理解,不知道是否正确</p>

<p>另一种选择是自定义一种c的数据类型,自动为我们做这样的转化.这样就可以直接使用FFI的绑定的函数而不用考虑辅助函数了.</p>

<h2 id="自定义c数据类型">自定义c数据类型</h2>

<p>在第一篇博文中我简要地提到过如何创建一个自定义c数据类型,但是这次我们更加仔细地过一遍.构建一个自定义c数据类型需要一个基础的c类型数据和两个转化函数,一个转化函数将Racket类型转化为c类型,另一个正好倒过来,将c类型的数据转化为Racket类型.</p>

<p>这样就有可能进行有趣的转化,比如将一个联合体自动地正确第拿出来.</p>

<p>我们来定义一个Cairo的path类型.path=一个序列化的元素表,元素=动作+动作的参数</p>

<p>首先用Racket来定义一个path类型</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">cairo-path</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
    <span class="kd">#:property</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._prop~3asequence))" style="color: inherit">prop:sequence</a></span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">(</span><span class="n">in-cairo-path</span> <span class="n">p</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这个定义中定义了<code>ptr</code>正如其名我们会在这里放一个指针,至于怎么使用我们之后再将</p>

<p>这里使用到了结构体的属性设置使得实例化的<code>cairo-path</code>可以自动序列化.这意味着你可以使用for循环来遍历这个序列或者使用<code>sequence-ref</code>直接访问某个元素. 这个属性通过一个函数来实现,此函数接受一个<code>p</code>(这里指实例化后元素自身).然后返回一个序列.</p>

<p>我们之后在定义这个<code>in-cairo-path</code>函数为我们自动的构建出相应的序列.现在看看对于这个结构体如何创建其c类型的定义</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_t</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">()</span>
      <span class="c1">; Extract pointer out of representation</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">racket-&gt;c</span> <span class="n">rkt</span><span class="p">)</span>
        <span class="p">(</span><span class="n">cairo-path-ptr</span> <span class="n">rkt</span><span class="p">))</span>
      <span class="c1">; Just apply the Racket constructor</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">c-&gt;racket</span> <span class="n">cobj</span><span class="p">)</span>
        <span class="p">(</span><span class="n">cairo-path</span> <span class="n">cobj</span><span class="p">))</span>
      <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/ctype.html#(def._((quote._~23~25foreign)._make-ctype))" style="color: inherit">make-ctype</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Pointer_Types.html#(def._((quote._~23~25foreign).__pointer))" style="color: inherit">_pointer</a></span>
                  <span class="n">racket-&gt;c</span>
                  <span class="n">c-&gt;racket</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这里的基础数据类型是<code>_pointer</code>,因为Cairo的API返回一个指针类型来代表,所以不可避免的需要用到指针. 从c到racket我们简单地将指针塞进了<code>cairo-path</code>构造函数.从racket将path类型转化为指针.</p>

<p>真正的工作由<code>in-cairo-path</code>完成的</p>

<p>遵循自顶向下的设计模式,我们来看看<code>in-cairo-path</code>的定义</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">; Cairo-Path -&gt; Sequence 将路径转化为序列</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">in-cairo-path</span> <span class="n">path</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">pp</span> <span class="p">(</span><span class="n">cairo-path-ptr</span> <span class="n">path</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span> <span class="n">len</span><span class="p">)</span>
      <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">pp</span> <span class="n">_simple_cairo_path_t</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._make-do-sequence))" style="color: inherit">make-do-sequence</a></span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">()</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="n">pos-&gt;element</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span><span class="p">)</span>
                <span class="p">(</span><span class="n">next-pos</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span><span class="p">)</span>
                <span class="mi">0</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">pos</span> <span class="n">len</span><span class="p">))</span>
                <span class="no">#f</span> <span class="no">#f</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p><code>cairo-path-prt</code>是定义<code>cairo-path</code>的副产品.拿到path后直接将其转化为指针,通过<a href="http://docs.racket-lang.org/reference/match.html#%28form._%28%28lib._racket%2Fmatch..rkt%29._match-define%29%29"><code>match-define</code></a>取出其中的路径部分,再将其序列化.</p>

<p>在从path对象中提取出数组和长度对象之后,我们将他们传递给一些辅助函数来实现序列化.通常定义一个序列的方式就是使用<code>make-do-sequence</code>函数.实质上<code>make-do-sequence</code>需要一堆参数来确定如何从序列中取出元素,如何推进序列,如何开始序列,如何结束序列.</p>

<p><strong>注意:</strong>从技术上来说,<code>make-do-sequence</code>函数接受的是一个形实替换程序(thunk),这个替换程序会产生一系列的值.这些值的作用就和参数一样.为什么这是一个替换程序是因为在序列开始之前你也许会需要运行一些初始化的代码(e.g. 打开一个网络连接).你的序列函数(如何推进一个序列)也会会建立在初始化之后的结果上.</p>

<p>在这里我们提供了一些柯里化的函数从底层的c数组中取出我们需要的元素.<code>pos-&gt;element</code>以及它的辅助函数就是干这个的</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="c1">; CPointer -&gt; Integer -&gt; Element</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">((</span><span class="n">pos-&gt;element</span> <span class="n">ptr</span><span class="p">)</span> <span class="n">pos</span><span class="p">)</span>
    <span class="c1">; Extract the data path header</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">header</span>
      <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span>
       <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span> <span class="n">_cairo_path_data_t</span> <span class="n">pos</span><span class="p">)</span>
       <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">type</span>   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span> <span class="n">header</span><span class="p">))</span>
    <span class="c1">; Length includes header, so subtract 1</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">len</span>    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">header</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">pos*</span>   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">pos</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">points</span> <span class="p">(</span><span class="n">get-points</span> <span class="n">ptr</span> <span class="n">pos*</span> <span class="n">len</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">type</span> <span class="n">points</span><span class="p">))</span>
<span class="c1">; CPointer Integer Integer -&gt; (Listof Data)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">get-points</span> <span class="n">ptr</span> <span class="n">pos</span> <span class="n">num-points</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">num-points</span><span class="p">)])</span>
      <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span>
                          <span class="n">_cairo_path_data_t</span>
                          <span class="c1">; offset argument</span>
                          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">pos</span> <span class="n">i</span><span class="p">))</span>
                 <span class="mi">1</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>这里涉及到Cairo指定的api使用方式.header元素后面跟着一些data元素.header元素指定长度,所以我们才能循环的取出数据,直到序列结束,每一步都需要将union对象取消应用将其中的正真的值取出.</p>

<p>推进序列比较简单,我们要做的只是,根据头元素指定的长度做一些算数运算而已.</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">((</span><span class="n">next-pos</span> <span class="n">ptr</span><span class="p">)</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">header</span>
      <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span>
       <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span> <span class="n">_cairo_path_data_t</span> <span class="n">pos</span><span class="p">)</span>
       <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">len</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">header</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">len</span> <span class="n">pos</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>打完收工. <code>racket
(define-cairo cairo-copy-path
    (_fun _cairo_t -&gt; _cairo_path_t))</code></p>

<p>将path对象当做序列使用 <code>racket
(do-cairo (λ (ctx)
              (cairo-move-to ctx 50.0 50.0)
              (cairo-line-to ctx 206.0 206.0)
              (cairo-move-to ctx 50.0 206.0)
              (cairo-line-to ctx 115.0 115.0)
              (define path (cairo-copy-path ctx))
              ; Using path as a sequence
              (for ([elem path])
                (displayln elem))
              (cairo-stroke ctx)))</code></p>

<p>最终的效果如下</p>

<div class="figure"><img src="/img/ffi3f.png" alt="" />
 <p class="caption"></p></div>

<p>完整的代码如下,有点长了</p>

<div class="brush: racket">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="kn">#lang </span><span class="nn">racket</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">racket/draw</span>
         <span class="n">ffi/unsafe</span>
         <span class="c1">; 避免产生冲突</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._except-in))" style="color: inherit">except-in</a></span> <span class="n">ffi/unsafe/define</span>
                    <span class="n">define-ffi-definer</span><span class="p">)</span>
         <span class="c1">; the new 3rd-party pkg</span>
         <span class="n">ffi-definer-convention</span>
         <span class="n">pict</span><span class="p">)</span>

<span class="c1">; C types</span>
<span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_tagged-pointers.html#(form._((lib._ffi/unsafe..rkt)._define-cpointer-type))" style="color: inherit">define-cpointer-type</a></span> <span class="n">_cairo_t</span><span class="p">)</span>
<span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_tagged-pointers.html#(form._((lib._ffi/unsafe..rkt)._define-cpointer-type))" style="color: inherit">define-cpointer-type</a></span> <span class="n">_cairo_surface_t</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_line_cap_t</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Enumerations_and_Masks.html#(def._((lib._ffi/unsafe..rkt).__enum))" style="color: inherit">_enum</a></span> <span class="o">'</span><span class="p">(</span><span class="ss">butt</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._round))" style="color: inherit">round</a></span> <span class="ss">square</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">cairo-lib</span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Loading_Foreign_Libraries.html#(def._((lib._ffi/unsafe..rkt)._ffi-lib))" style="color: inherit">ffi-lib</a></span> <span class="no">#f</span><span class="p">))</span>
<span class="p">(</span><span class="n">define-ffi-definer</span> <span class="n">define-cairo</span> <span class="n">cairo-lib</span>
  <span class="c1">; describes how to transform from</span>
  <span class="c1">; Racket to C ids</span>
  <span class="kd">#:make-c-id</span> <span class="n">convention:hyphen-&gt;underscore</span><span class="p">)</span>

<span class="c1">; the foreign functions</span>
<span class="c1">; note lack of #:c-id keyword arguments</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-create</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_surface_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">_cairo_t</span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-move-to</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-line-to</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-set-line-width</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-stroke</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>
<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-set-line-cap</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="n">_cairo_line_cap_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Other_Atomic_Types.html#(def._((quote._~23~25foreign).__void))" style="color: inherit">_void</a></span><span class="p">))</span>

<span class="c1">; (_cairo_t -&gt; Void) -&gt; Pict</span>
<span class="c1">; do some drawing and give us the pict</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">do-cairo</span> <span class="n">f</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bt</span> <span class="p">(</span><span class="n">make-bitmap</span> <span class="mi">256</span> <span class="mi">256</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">bt-surface</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">bt</span> <span class="n">get-handle</span><span class="p">))</span>
  <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">cairo-create</span> <span class="n">bt-surface</span><span class="p">))</span>
  <span class="p">(</span><span class="n">linewidth</span> <span class="mi">2</span> <span class="p">(</span><span class="n">frame</span> <span class="p">(</span><span class="n">bitmap</span> <span class="n">bt</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_status_t</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_data_type_t</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/Enumerations_and_Masks.html#(def._((lib._ffi/unsafe..rkt).__enum))" style="color: inherit">_enum</a></span> <span class="o">'</span><span class="p">(</span><span class="ss">move-to</span> <span class="ss">line-to</span> <span class="ss">curve-to</span> <span class="ss">close-path</span><span class="p">)))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_data_t</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt).__union))" style="color: inherit">_union</a></span>
   <span class="c1">;;第一种情况</span>
   <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n">_cairo_path_data_type_t</span>
                 <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">)</span>
   <span class="c1">;the point case</span>
   <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((quote._~23~25foreign).__double))" style="color: inherit">_double</a></span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_simple_cairo_path_t</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Struct_Types.html#(def._((lib._ffi/unsafe..rkt).__list-struct))" style="color: inherit">_list-struct</a></span> <span class="n">_cairo_status_t</span>
                <span class="n"><a href="http://docs.racket-lang.org/foreign/Pointer_Types.html#(def._((quote._~23~25foreign).__pointer))" style="color: inherit">_pointer</a></span>
                <span class="n"><a href="http://docs.racket-lang.org/foreign/Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" style="color: inherit">_int</a></span><span class="p">))</span>

<span class="c1">;; (define a-path #f)</span>

<span class="c1">;; (do-cairo (λ (ctx)</span>
<span class="c1">;;             ;;确保当前的路径非空</span>
<span class="c1">;;             (cairo-move-to ctx 50.0 50.0)</span>
<span class="c1">;;             (cairo-line-to ctx 206.0 206.0)</span>
<span class="c1">;;             (cairo-move-to ctx 50.0 206.0)</span>
<span class="c1">;;             (cairo-line-to ctx 115.0 115.0)</span>
<span class="c1">;;             ;;得到当前的路径</span>
<span class="c1">;;             (set! a-path (cairo-copy-path ctx))</span>
<span class="c1">;;             ;;画出路径,所以最后才做</span>
<span class="c1">;;             (cairo-stroke ctx)</span>
<span class="c1">;;             ))</span>


<span class="c1">;; (define simple-path</span>
<span class="c1">;;   (ptr-ref a-path _simple_cairo_path_t))</span>




<span class="c1">;; (define array</span>
<span class="c1">;;   (ptr-ref ;指针</span>
<span class="c1">;;    (second simple-path)</span>
<span class="c1">;;    (_array/list _cairo_path_data_t</span>
<span class="c1">;;                 ;;长度</span>
<span class="c1">;;                 (third simple-path))))</span>


<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">cairo-path</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
  <span class="kd">#:property</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._prop~3asequence))" style="color: inherit">prop:sequence</a></span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">(</span><span class="n">in-cairo-path</span> <span class="n">p</span><span class="p">)))</span>


<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">_cairo_path_t</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">()</span>
    <span class="c1">;;使用指针来表示</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">racket-&gt;c</span> <span class="n">rkt</span><span class="p">)</span>
      <span class="p">(</span><span class="n">cairo-path-ptr</span> <span class="n">rkt</span><span class="p">))</span>
    <span class="c1">;;直接使用Racket的构造函数</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">c-&gt;racket</span> <span class="n">cobj</span><span class="p">)</span>
      <span class="p">(</span><span class="n">cairo-path</span> <span class="n">cobj</span><span class="p">))</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/ctype.html#(def._((quote._~23~25foreign)._make-ctype))" style="color: inherit">make-ctype</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/Pointer_Types.html#(def._((quote._~23~25foreign).__pointer))" style="color: inherit">_pointer</a></span>
                <span class="n">racket-&gt;c</span>
                <span class="n">c-&gt;racket</span><span class="p">)))</span>

<span class="p">(</span><span class="n">define-cairo</span> <span class="n">cairo-copy-path</span>
  <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_procedures.html#(form._((lib._ffi/unsafe..rkt).__fun))" style="color: inherit">_fun</a></span> <span class="n">_cairo_t</span> <span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">_cairo_path_t</span><span class="p">))</span>


<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">in-cairo-path</span> <span class="n">path</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">pp</span> <span class="p">(</span><span class="n">cairo-path-ptr</span> <span class="n">path</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match-define))" style="color: inherit">match-define</a></span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span> <span class="n">len</span><span class="p">)</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">pp</span> <span class="n">_simple_cairo_path_t</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._make-do-sequence))" style="color: inherit">make-do-sequence</a></span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">()</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/values.html#(def._((quote._~23~25kernel)._values))" style="color: inherit">values</a></span> <span class="p">(</span><span class="n">pos-&gt;element</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span><span class="p">)</span>
             <span class="p">(</span><span class="n">next-pos</span> <span class="n"><a href="http://docs.racket-lang.org/foreign/C_Array_Types.html#(def._((lib._ffi/unsafe..rkt)._array-ptr))" style="color: inherit">array-ptr</a></span><span class="p">)</span>
             <span class="mi">0</span>
             <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span> <span class="n">pos</span> <span class="n">len</span><span class="p">))</span>
             <span class="no">#f</span> <span class="no">#f</span><span class="p">))))</span>


<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">((</span><span class="n">pos-&gt;element</span> <span class="n">ptr</span><span class="p">)</span> <span class="n">pos</span><span class="p">)</span>
  <span class="c1">;;取出数据路径的头部</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">header</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span>
     <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span> <span class="n">_cairo_path_data_t</span> <span class="n">pos</span><span class="p">)</span>
     <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">type</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" style="color: inherit">first</a></span> <span class="n">header</span><span class="p">))</span>
  <span class="c1">;;长度包括了头部所以要减一</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">len</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">header</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">pos*</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">pos</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">points</span> <span class="p">(</span><span class="n">get-points</span> <span class="n">ptr</span> <span class="n">pos*</span> <span class="n">len</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">type</span> <span class="n">points</span><span class="p">))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">get-points</span> <span class="n">ptr</span> <span class="n">pos</span> <span class="n">num-points</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">num-points</span><span class="p">)])</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span>
                        <span class="n">_cairo_path_data_t</span>
                        <span class="c1">;;偏移量参数</span>
                        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">pos</span> <span class="n">i</span><span class="p">))</span>
               <span class="mi">1</span><span class="p">)))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">((</span><span class="n">next-pos</span> <span class="n">ptr</span><span class="p">)</span> <span class="n">pos</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">header</span>
    <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/C_Union_Types.html#(def._((lib._ffi/unsafe..rkt)._union-ref))" style="color: inherit">union-ref</a></span>
     <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/foreign/foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._ptr-ref))" style="color: inherit">ptr-ref</a></span> <span class="n">ptr</span> <span class="n">_cairo_path_data_t</span> <span class="n">pos</span><span class="p">)</span>
     <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">len</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" style="color: inherit">second</a></span> <span class="n">header</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">len</span> <span class="n">pos</span><span class="p">))</span>


<span class="c1">;; (define-cairo cairo-copy-path</span>
<span class="c1">;;   (_fun _cairo_t -&gt; _cairo_path_t))</span>



<span class="p">(</span><span class="n">do-cairo</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cairo-move-to</span> <span class="n">ctx</span> <span class="mf">50.0</span> <span class="mf">50.0</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cairo-line-to</span> <span class="n">ctx</span> <span class="mf">206.0</span> <span class="mf">206.0</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cairo-move-to</span> <span class="n">ctx</span> <span class="mf">50.0</span> <span class="mf">206.0</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cairo-line-to</span> <span class="n">ctx</span> <span class="mf">115.0</span> <span class="mf">115.0</span><span class="p">)</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">path</span> <span class="p">(</span><span class="n">cairo-copy-path</span> <span class="n">ctx</span><span class="p">))</span>
            <span class="c1">; Using path as a sequence</span>
            <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="p">([</span><span class="n">elem</span> <span class="n">path</span><span class="p">])</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" style="color: inherit">displayln</a></span> <span class="n">elem</span><span class="p">))</span>
            <span class="p">(</span><span class="n">cairo-stroke</span> <span class="n">ctx</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>
            </div>
        </div>
    </div>
    <footer>
        <script type="text/javascript">
          !function(d,s,id){
              var js,fjs=d.getElementsByTagName(s)[0];
              if(!d.getElementById(id)){
                  js=d.createElement(s);
                  js.id=id;
                  js.src="//platform.twitter.com/widgets.js";
                  fjs.parentNode.insertBefore(js,fjs);
              }
          }(document,"script","twitter-wjs");
        </script>
        <a href="https://twitter.com/share"
           class="twitter-share-button"
           data-url="http://shenxs.github.io/blog/2016/07/22/racket-ffi-3/"
           data-dnt="true">
          "Tweet"</a>
        <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
        <g:plusone size="medium" href="http://shenxs.github.io/blog/2016/07/22/racket-ffi-3/"></g:plusone>
        <script type="text/javascript">
          var disqus_shortname = 'shortname';
          (function() {
              var dsq = document.createElement('script');
              dsq.type = 'text/javascript';
              dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <div id="disqus_thread"></div>
        <ul class="pager">
        <li class="previous">
          <a href="/blog/2016/10/06/raspberry-pi-gpio/">&larr; <em>Raspberry Pi GPIO</em></a>
        </li>
        <li class="next">
          <a href="/blog/2016/07/21/racket-ffi-2/"><em>Racket FFI 2</em> &rarr;</a>
        </li>
        </ul>
    </footer>
</article>
                </div>
            </div>
            <footer>
                <hr />
                <p><a href="https://twitter.com/racketlang"
                      class="twitter-follow-button"
                      data-show-count="false"
                      data-lang="en">
                     "Follow RacketLang"
                   </a>
                   <script type="text/javascript">
                     !function(d,s,id){
                         var js,fjs=d.getElementsByTagName(s)[0];
                         if(!d.getElementById(id)){
                             js=d.createElement(s);
                             js.id=id;
                             js.src="//platform.twitter.com/widgets.js";
                             fjs.parentNode.insertBefore(js,fjs);
                         }
                     }(document,"script","twitter-wjs");
                   </script></p>
                <p>由<a href="https://github.com/greghendershott/frog">Frog</a>强力驱动,
                the <strong>fr</strong>ozen bl<strong>og</strong> tool.</p>
                <p><em>Program is just another name of the lost art of thinking</em>.</p>
            </footer>
        </div>
        <!-- </body> JS -->
        <script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
        <script type="text/javascript" src="/js/bootstrap.min.js"></script>
        </body>
</html>